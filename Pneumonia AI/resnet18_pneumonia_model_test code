import torch
import torch.nn as nn
from torchvision import datasets, transforms, models
from torch.utils.data import DataLoader
from tqdm import tqdm
import os
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import cv2
from PIL import Image
from sklearn.metrics import accuracy_score, confusion_matrix

# =====================================================
# Device
# =====================================================
DEVICE = "cuda" if torch.cuda.is_available() else "cpu"

# =====================================================
# Load trained model
# =====================================================
MODEL_PATH = r"C:\Users\user\OneDrive\바탕 화면\코딩 연습\Pneumonia AI\Model\resnet18_pneumonia_best0.928.pth"

checkpoint = torch.load(MODEL_PATH, map_location=DEVICE)

class_names = checkpoint["class_names"]

model = models.resnet18(pretrained=False)
model.fc = nn.Sequential(
        # nn.Dropout(p=0.5),  # 필요시 여기에 활성화
        nn.Linear(model.fc.in_features, len(class_names))
    )
model.to(DEVICE)

model.load_state_dict(checkpoint["model_state_dict"])
model.eval()



print(
    f"✅ Model loaded "
    f"(epoch={checkpoint['epoch']}, "
    f"test_acc={checkpoint['test_accuracy']:.3f})"
)


TEST_DIR = r"C:\Users\user\OneDrive\바탕 화면\코딩 데이터\Pneumonia CT images\test"

transform = transforms.Compose([
    transforms.Resize((384, 384)),
    transforms.ToTensor(),
    transforms.Normalize(
        mean=[0.485, 0.456, 0.406],
        std=[0.229, 0.224, 0.225]
    )
])

test_dataset = datasets.ImageFolder(TEST_DIR, transform=transform)
test_loader = DataLoader(
    test_dataset,
    batch_size=4,
    shuffle=True
)
print("Test classes:", test_dataset.classes)


all_preds = []
all_labels = []

with torch.no_grad():
    for images, labels in test_loader:
        images = images.to(DEVICE)
        labels = labels.to(DEVICE)

        outputs = model(images)
        preds = outputs.argmax(dim=1)

        all_preds.extend(preds.cpu().numpy())
        all_labels.extend(labels.cpu().numpy())

acc = accuracy_score(all_labels, all_preds)
cm = confusion_matrix(all_labels, all_preds)

print(f"[a folder] Accuracy: {acc:.3f}")

plt.figure(figsize=(4, 4))
sns.heatmap(
    cm,
    annot=True,
    fmt="d",
    cmap="Greens",
    xticklabels=class_names,
    yticklabels=class_names
)
plt.xlabel("Predicted")
plt.ylabel("True")
plt.title("Confusion Matrix (a folder)")
plt.tight_layout()
plt.show()